<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.usher.dao.InternalExamsDuolingoImageDao">
	<select id="getExamsDuolingoImageList" resultType="com.usher.dto.InternalExamsDuolingoImageDto" parameterType="com.usher.dto.InternalExamsDuolingoImageDto">
		select
			a.id,
			to_char(a.created,'yyyy-mm-dd hh24:mi:ss') as created,
			a.created_id,
			concat(coalesce(b.last_name,''),coalesce(b.first_name,'')) as created_name,
			to_char(a.modified,'yyyy-mm-dd hh24:mi:ss') as modified,
			a.modified_id,
			concat(coalesce(c.last_name,''),coalesce(c.first_name,'')) as modified_name,
			a.status,
			a.section,
			a.book,
			a.volume,
			a."group",
			a.article,
			a.image_title,
			a.image_url,
			a.image_keyword,
			a.score_keyword,
			a.score_word,
			a.image_sort
		from
			internal_exams_duolingo_image a
			left join auth_user b on a.created_id = b.id
			left join auth_user c on a.modified_id = c.id
		where
			a.section = #{section}
			and a.book = #{book}
			and a.volume = #{volume}
			and a."group" = #{group}
			and a.article = #{article}
		order by a.image_sort
	</select>
	
	<select id="getExamsDuolingoImage" resultType="com.usher.dto.InternalExamsDuolingoImageDto" parameterType="com.usher.dto.InternalExamsDuolingoImageDto">
		select
			a.id,
			to_char(a.created,'yyyy-mm-dd hh24:mi:ss') as created,
			a.created_id,
			concat(coalesce(b.last_name,''),coalesce(b.first_name,'')) as created_name,
			to_char(a.modified,'yyyy-mm-dd hh24:mi:ss') as modified,
			a.modified_id,
			concat(coalesce(c.last_name,''),coalesce(c.first_name,'')) as modified_name,
			a.status,
			a.section,
			a.book,
			a.volume,
			a."group",
			a.article,
			a.image_title,
			a.image_url,
			a.image_keyword,
			a.score_keyword,
			a.score_word,
			a.image_sort
		from
			internal_exams_duolingo_image a
			left join auth_user b on a.created_id = b.id
			left join auth_user c on a.modified_id = c.id
		where
			a.id = #{id}
	</select>
	<select id="getExamsDuolingoImageSort" resultType="com.usher.dto.InternalExamsDuolingoImageDto" parameterType="com.usher.dto.InternalExamsDuolingoImageDto">
		select coalesce(max(image_sort),0) + 1 as image_sort 
		from
			internal_exams_duolingo_image a
		where
			a.section = #{section}
			and a.book = #{book}
			and a.volume = #{volume}
			and a."group" = #{group}
			and a.article = #{article}
	</select>
	<insert id="insertDuolingoImage" parameterType="com.usher.dto.InternalExamsDuolingoImageDto" useGeneratedKeys="true" keyProperty="id" >
		insert into internal_exams_duolingo_image (
			created,
			created_id,
			modified,
			modified_id,
			status,
			section,
			book,
			volume,
			"group",
			article,
		    image_title,
			image_url,
			image_keyword,
			score_keyword,
			score_word,
			image_sort
		) values (
			now(),
			#{created_id},
			now(),
			#{modified_id},
			#{status},
			#{section},
			#{book},
			#{volume},
			#{group},
			#{article},
		    #{image_title},
			#{image_url},
			#{image_keyword},
			#{score_keyword},
			#{score_word},
			#{image_sort}
		)
	</insert>	
	
	<update id="updateDuolingoImage" parameterType="com.usher.dto.InternalExamsDuolingoImageDto">
		update internal_exams_duolingo_image set
			modified = now(),
			modified_id = #{modified_id},
			status = #{status},
			image_title = #{image_title},
			image_url = #{image_url},
			image_keyword = #{image_keyword},
			score_keyword = #{score_keyword},
			score_word = #{score_word}
		where
			id = #{id}
	</update>
	<update id="updateDuolingoImageSort" parameterType="com.usher.dto.InternalExamsDuolingoImageDto">
		update internal_exams_duolingo_image set
			modified = now(),
			modified_id = #{modified_id},
			image_sort = #{image_sort}
		where
			id = #{id}
	</update>	
	<delete id="deleteDuolingoImage" parameterType="com.usher.dto.InternalExamsDuolingoImageDto">
		delete from internal_exams_duolingo_image
		where
			id = #{id}
	</delete>			
</mapper>